
import React, { useState } from 'react';
import { FormData as AppFormData, HomeDetails } from '../types';
import { FormField, FormSection, SelectionCard } from './FormElements';
import { homeFields, driverFields } from './formFields';
import VehicleFormSection from './VehicleFormSection';
import HelpModal from './HelpModal';
import { HOME_FAQS, AUTO_FAQS } from '../constants';
import { HomeIcon } from './icons/HomeIcon';
import { CarIcon } from './icons/CarIcon';
import { HomeCarIcon } from './icons/HomeCarIcon';

interface HomeAutoFormProps {
  onSubmit: (data: Omit<AppFormData, 'insuranceType' | 'dynamicAnswers'>) => void;
  onBack: () => void;
}

type FormState = Omit<AppFormData, 'insuranceType' | 'dynamicAnswers'>;
type ProductType = 'home_auto' | 'home' | 'auto' | '';

const HomeAutoForm: React.FC<HomeAutoFormProps> = ({ onSubmit, onBack }) => {
  const [productType, setProductType] = useState<ProductType>('');
  const [formData, setFormData] = useState<FormState>({
    fullName: '',
    email: '',
    phone: '',
    homeDetails: {},
    drivers: [{ id: Date.now() }],
    vehicles: [{ id: Date.now() }],
  });
  const [errors, setErrors] = useState<Partial<Record<keyof HomeDetails, string>>>({});
  const [isHelpModalOpen, setIsHelpModalOpen] = useState<'home' | 'auto' | null>(null);

  const handleProductTypeChange = (type: ProductType) => {
    setProductType(type);
    // Clear irrelevant form data to prevent carrying over old data
    setFormData(prev => {
      const newFormData: FormState = {
        fullName: prev.fullName,
        email: prev.email,
        phone: prev.phone,
      };
      if (type === 'home') {
        newFormData.homeDetails = prev.homeDetails || {};
      } else if (type === 'auto') {
        newFormData.drivers = prev.drivers || [{ id: Date.now() }];
        newFormData.vehicles = prev.vehicles || [{ id: Date.now() }];
      } else if (type === 'home_auto') {
        newFormData.homeDetails = prev.homeDetails || {};
        newFormData.drivers = prev.drivers || [{ id: Date.now() }];
        newFormData.vehicles = prev.vehicles || [{ id: Date.now() }];
      }
      return newFormData;
    });
  };

  const validate = (name: keyof HomeDetails, value: string) => {
    if (name === 'propertyAddress') {
      if (!value.trim()) return 'Property address is required.';
      if (value.trim().length < 5) return 'Please enter a valid address.';
    }
    return null;
  };

  const handleContactChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleHomeDetailsChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    const key = name as keyof HomeDetails;
    setFormData(prev => ({ ...prev, homeDetails: { ...prev.homeDetails, [key]: value } }));
    if (errors[key]) {
      setErrors(prev => { const newErrors = { ...prev }; delete newErrors[key]; return newErrors; });
    }
  };
  
  const handleHomeDetailsBlur = (e: React.FocusEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    const key = name as keyof HomeDetails;
    const error = validate(key, value);
    if (error) setErrors(prev => ({ ...prev, [key]: error }));
  };

  const handleDriversChange = (index: number, e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData(prev => {
      const newArray = [...(prev.drivers || [])];
      newArray[index] = { ...newArray[index], [name]: value };
      return { ...prev, drivers: newArray };
    });
  };

  const addDriver = () => setFormData(prev => ({ ...prev, drivers: [...(prev.drivers || []), { id: Date.now() }] }));
  const removeDriver = (index: number) => setFormData(prev => ({ ...prev, drivers: (prev.drivers || []).filter((_, i) => i !== index) }));

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!productType) {
        // Simple validation to ensure a product type is selected
        alert('Please select a quote type to continue.');
        return;
    }
    const newErrors: Partial<Record<keyof HomeDetails, string>> = {};
    if (productType === 'home' || productType === 'home_auto') {
      const propertyAddressError = validate('propertyAddress', formData.homeDetails?.propertyAddress || '');
      if (propertyAddressError) newErrors.propertyAddress = propertyAddressError;
    }
    setErrors(newErrors);

    if (Object.keys(newErrors).length === 0) {
      onSubmit({ ...formData, productSubType: productType });
    }
  };

  const showHomeSection = productType === 'home' || productType === 'home_auto';
  const showAutoSection = productType === 'auto' || productType === 'home_auto';

  return (
    <div className="animate-fade-in">
      <div className="text-center">
        <h2 className="text-2xl sm:text-3xl font-bold text-zinc-800 mb-2">Home & Auto Insurance Quote</h2>
        <div className="max-w-2xl mx-auto text-left bg-zinc-50 p-4 rounded-lg text-sm text-zinc-600 mt-4 border border-zinc-200">
          <p className="font-semibold text-zinc-700">Why We Ask These Questions:</p>
          <ul className="list-disc list-inside mt-2 space-y-1">
            <li><span className="font-semibold">Accuracy:</span> Ensures your quote matches your actual coverage needs.</li>
            <li><span className="font-semibold">Savings:</span> Helps identify discounts (e.g., alarms, winter tires).</li>
            <li><span className="font-semibold">Speed:</span> Complete info = faster quote turnaround.</li>
          </ul>
        </div>
      </div>
      
      <HelpModal isOpen={isHelpModalOpen === 'home'} onClose={() => setIsHelpModalOpen(null)} title="Home Insurance FAQs" faqs={HOME_FAQS} />
      <HelpModal isOpen={isHelpModalOpen === 'auto'} onClose={() => setIsHelpModalOpen(null)} title="Auto Insurance FAQs" faqs={AUTO_FAQS} />

      <form onSubmit={handleSubmit} className="mt-8 max-w-3xl mx-auto">
        <FormSection title="Step 1: Select Your Quote Type">
          <div className="md:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
            <SelectionCard title="Home & Auto" icons={<HomeCarIcon className="w-8 h-8"/>} selected={productType === 'home_auto'} onClick={() => handleProductTypeChange('home_auto')} />
            <SelectionCard title="Home Only" icons={<HomeIcon className="w-8 h-8"/>} selected={productType === 'home'} onClick={() => handleProductTypeChange('home')} />
            <SelectionCard title="Auto Only" icons={<CarIcon className="w-8 h-8"/>} selected={productType === 'auto'} onClick={() => handleProductTypeChange('auto')} />
          </div>
        </FormSection>

        {productType && (
          <>
            <FormSection title="ðŸ“ž Contact Information" intro="Required for quote delivery">
              <FormField id="fullName" name="fullName" label="Full Name" value={formData.fullName} onChange={handleContactChange} />
              <FormField id="phone" name="phone" label="Phone Number" value={formData.phone} onChange={handleContactChange} />
              <FormField id="email" name="email" label="Email Address" value={formData.email} onChange={handleContactChange} />
            </FormSection>

            {showHomeSection && (
              <FormSection title="ðŸ  Home Insurance Details">
                <div className="md:col-span-2 flex justify-start">
                    <button type="button" onClick={() => setIsHelpModalOpen('home')} className="text-sm font-semibold text-teal-600 hover:text-teal-800 hover:underline">
                        Need Help with Home Details?
                    </button>
                </div>
                {homeFields.map(field => (
                    <FormField key={field.name} id={`homeDetails.${field.name}`} name={field.name} label={field.label} placeholder={field.placeholder} as={field.as} value={(formData.homeDetails?.[field.name] as string) || ''} onChange={handleHomeDetailsChange} onBlur={handleHomeDetailsBlur} error={errors[field.name]}/>
                ))}
              </FormSection>
            )}

            {showAutoSection && (
              <FormSection title="ðŸš— Auto Insurance Details">
                <div className="md:col-span-2 flex justify-start">
                    <button type="button" onClick={() => setIsHelpModalOpen('auto')} className="text-sm font-semibold text-teal-600 hover:text-teal-800 hover:underline">
                        Need Help with Auto Details?
                    </button>
                </div>
                {formData.drivers?.map((driver, index) => (
                    <div key={driver.id} className="md:col-span-2 contents">
                        <FormSection title={`Driver ${index + 1} Information`} intro="All household drivers">
                            {driverFields.map(field => (
                                <FormField key={field.name} id={`driver${index}.${field.name}`} name={field.name} label={field.label} placeholder={field.placeholder} as={field.as} value={(driver?.[field.name] as string) || ''} onChange={(e) => handleDriversChange(index, e)} />
                            ))}
                            {formData.drivers && formData.drivers.length > 1 && (
                                <div className="md:col-span-2 flex justify-end">
                                    <button type="button" onClick={() => removeDriver(index)} className="text-sm font-semibold text-red-600 hover:text-red-800">Remove Driver</button>
                                </div>
                            )}
                        </FormSection>
                    </div>
                ))}
                <div className="md:col-span-2 mt-4 flex justify-start">
                    <button type="button" onClick={addDriver} className="px-4 py-2 text-sm bg-zinc-100 text-zinc-700 font-semibold rounded-lg hover:bg-zinc-200 transition-colors">
                        + Add Another Driver
                    </button>
                </div>
                <div className="md:col-span-2 contents">
                  <VehicleFormSection vehicles={formData.vehicles || []} setFormData={setFormData} />
                </div>
              </FormSection>
            )}

            <div className="flex flex-col-reverse sm:flex-row gap-4 pt-8 mt-8 border-t border-zinc-200">
              <button type="button" onClick={onBack} className="w-full px-6 py-3 bg-zinc-100 text-zinc-700 font-semibold rounded-lg hover:bg-zinc-200 transition-colors">
                Back
              </button>
              <button type="submit" className="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition-colors shadow-sm hover:shadow-md">
                Continue to Summary
              </button>
            </div>
          </>
        )}
      </form>
    </div>
  );
};

export default HomeAutoForm;
