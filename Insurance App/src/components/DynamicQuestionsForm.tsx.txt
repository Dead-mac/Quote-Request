
import React, { useState } from 'react';
import { DynamicQuestion } from '../types';

interface DynamicFieldProps {
  question: DynamicQuestion;
  value: string;
  error?: string;
  onChange: (value: string) => void;
  onBlur: () => void;
}

// Standalone component extracted from the old `renderInput` function to prevent re-renders.
const DynamicField: React.FC<DynamicFieldProps> = ({ question, value, error, onChange, onBlur }) => {
  const errorId = `${question.id}-error`;
  const hasError = !!error;

  const commonProps = {
    id: question.id,
    value: value,
    onChange: (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => onChange(e.target.value),
    onBlur: onBlur,
    placeholder: question.placeholder || '',
    className: `w-full px-4 py-3 bg-white border rounded-xl focus:outline-none focus:ring-2 transition-colors duration-200 ${
      hasError
        ? 'border-red-500 focus:border-red-500 focus:ring-red-500/20'
        : 'border-zinc-300 hover:border-zinc-400 focus:border-teal-500 focus:ring-teal-500/20'
    }`,
    'aria-invalid': hasError,
    'aria-describedby': hasError ? errorId : undefined,
  };

  if (question.type === 'textarea') {
    return <textarea {...commonProps} rows={4} />;
  }
  
  return <input type={question.type} {...commonProps} />;
};


interface DynamicQuestionsFormProps {
  questions: DynamicQuestion[];
  onSubmit: (answers: { [key: string]: string }) => void;
  onBack: () => void;
}

const DynamicQuestionsForm: React.FC<DynamicQuestionsFormProps> = ({ questions, onSubmit, onBack }) => {
  const [answers, setAnswers] = useState<{ [key: string]: string }>({});
  const [errors, setErrors] = useState<{ [key: string]: string }>({});

  const validateField = (question: DynamicQuestion, value: string) => {
    if (!value?.trim()) {
      return `${question.label} is required.`;
    }
    return null;
  };

  const handleAnswerChange = (questionId: string, value: string) => {
    const question = questions.find(q => q.id === questionId);
    if (!question) return;

    setAnswers(prev => ({ ...prev, [questionId]: value }));
    const error = validateField(question, value);
    setErrors(prev => {
      const newErrors = { ...prev };
      if (error) {
        newErrors[questionId] = error;
      } else {
        delete newErrors[questionId];
      }
      return newErrors;
    });
  };

  const handleBlur = (questionId: string) => {
    const question = questions.find(q => q.id === questionId);
    if (!question) return;

    const value = answers[questionId] || '';
    const error = validateField(question, value);
    if (error) {
      setErrors(prev => ({ ...prev, [questionId]: error }));
    }
  };

  const validateAll = () => {
    const newErrors: { [key: string]: string } = {};
    questions.forEach(q => {
      const value = answers[q.id] || '';
      const error = validateField(q, value);
      if (error) {
        newErrors[q.id] = error;
      }
    });
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (validateAll()) {
      onSubmit(answers);
    }
  };
  
  return (
    <div className="animate-fade-in">
      <h2 className="text-2xl sm:text-3xl font-bold text-center text-zinc-800 mb-2">A few more details...</h2>
      <p className="text-center text-zinc-600 mb-8">This helps us prepare your personalized quote.</p>
      <form onSubmit={handleSubmit} className="space-y-6 max-w-lg mx-auto">
        {questions.map(question => (
          <div key={question.id}>
            <label htmlFor={question.id} className="block text-sm font-medium text-zinc-700 mb-1">
              {question.label}
            </label>
            <DynamicField
              question={question}
              value={answers[question.id] || ''}
              error={errors[question.id]}
              onChange={(value) => handleAnswerChange(question.id, value)}
              onBlur={() => handleBlur(question.id)}
            />
            {errors[question.id] && <p id={`${question.id}-error`} className="text-red-600 text-xs mt-1">{errors[question.id]}</p>}
          </div>
        ))}
        <div className="flex flex-col-reverse sm:flex-row gap-4 pt-4">
          <button type="button" onClick={onBack} className="w-full px-6 py-3 bg-zinc-100 text-zinc-700 font-semibold rounded-lg hover:bg-zinc-200 transition-colors">
            Back
          </button>
          <button type="submit" className="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition-colors shadow-sm hover:shadow-md">
            Continue
          </button>
        </div>
      </form>
    </div>
  );
};

export default DynamicQuestionsForm;
